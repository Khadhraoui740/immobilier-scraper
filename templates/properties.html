{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="page">
        <h1>Gestion des Propriétés</h1>

        <div class="filter-bar">
            <input type="text" id="search" placeholder="Rechercher..." class="filter-input">
            <select id="status-filter" class="filter-input">
                <option value="">Tous les statuts</option>
                <option value="disponible">Disponible</option>
                <option value="contacté">Contacté</option>
                <option value="visité">Visité</option>
                <option value="rejeté">Rejeté</option>
            </select>
            <select id="sort-filter" class="filter-input" onchange="updateSort(this.value)">
                <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Plus récentes</option>
                <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Plus anciennes</option>
                <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Prix décroissant</option>
                <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Prix croissant</option>
            </select>
        </div>

        <div class="properties-grid">
            {% for prop in properties %}
            <div class="property-card">
                <div class="property-header">
                    <h3>{{ prop.title or 'Sans titre' }}</h3>
                    <span class="badge badge-{{ (prop.source or 'unknown')|lower }}">{{ prop.source or 'Inconnu' }}</span>
                </div>
                
                <div class="property-body">
                    <p><strong>Prix:</strong> {{ prop.price }}</p>
                    <p><strong>&#128205; Commune:</strong> {{ prop.location }}</p>
                    <p><strong>&#128197; Publié:</strong> {{ prop.posted_date_formatted }}</p>
                    <p><strong>Statut:</strong> {{ prop.status or 'N/A' }}</p>
                    <p><strong>DPE:</strong> <span class="dpe dpe-{{ (prop.dpe or 'N/A')|lower }}">{{ prop.dpe or 'N/A' }}</span></p>
                </div>

                <div class="property-footer">
                    {% if prop.url %}
                    <a href="{{ prop.url }}" target="_blank" class="btn btn-sm btn-primary">
                    {% else %}
                    <a href="/property/{{ prop.id }}" class="btn btn-sm btn-primary">
                    {% endif %}
                        <i class="fas fa-external-link-alt"></i> Voir
                    </a>
                    <button class="btn btn-sm btn-secondary" onclick="editProperty('{{ prop.id }}')">
                        <i class="fas fa-edit"></i> Éditer
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="pagination">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}&sort={{ sort_by }}" class="btn btn-sm">← Précédent</a>
            {% endif %}
            
            <span>Page {{ page }} / {{ pages }}</span>
            
            {% if page < pages %}
            <a href="?page={{ page + 1 }}&sort={{ sort_by }}" class="btn btn-sm">Suivant →</a>
            {% endif %}
        </div>
    </div>
</div>

<script>
function updateSort(sortValue) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortValue);
    url.searchParams.set('page', '1'); // Reset à la page 1 lors du tri
    window.location.href = url.toString();
}

function editProperty(id) {
    fetch(`/api/property/${id}`)
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const prop = data.property;
            const newStatus = prompt('Nouveau statut:', prop.status);
            if (newStatus) {
                fetch(`/api/property/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: newStatus})
                })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        location.reload();
                    }
                });
            }
        }
    });
}
</script>
{% endblock %}
