{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="page">
        <h1>‚öôÔ∏è Configuration Email SMTP</h1>

        <div class="card">
            <h2>Param√®tres SMTP</h2>
            <form id="smtp-form">
                <div class="form-group">
                    <label for="smtp_server">Serveur SMTP</label>
                    <input type="text" id="smtp_server" name="smtp_server" placeholder="smtp.gmail.com" required>
                </div>

                <div class="form-group">
                    <label for="smtp_port">Port SMTP</label>
                    <input type="number" id="smtp_port" name="smtp_port" placeholder="587" value="587" required>
                </div>

                <div class="form-group">
                    <label for="from_email">Adresse Email</label>
                    <input type="email" id="from_email" name="from_email" placeholder="votre@email.com" required>
                </div>

                <div class="form-group">
                    <label for="password">Mot de passe Email</label>
                    <input type="password" id="password" name="password" placeholder="Votre mot de passe ou cl√© d'application">
                    <small>N.B. Non stock√© en base, uniquement utilis√© pour l'envoi</small>
                </div>

                <div class="form-group">
                    <label for="recipient_email">Email de R√©ception</label>
                    <input type="email" id="recipient_email" name="recipient_email" placeholder="destinataire@email.com" required>
                </div>

                <button type="submit" class="btn btn-primary">üíæ Sauvegarder</button>
                <button type="button" class="btn btn-secondary" onclick="testSMTP()">üß™ Test de Connexion</button>
            </form>

            <div id="test-result" style="margin-top: 20px; display: none;"></div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>√âtat Actuel</h2>
            <div id="status">Chargement...</div>
        </div>
    </div>
</div>

<script>
function loadConfig() {
    fetch('/api/config/get')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.config) {
                const cfg = data.config;
                document.getElementById('smtp_server').value = cfg.smtp_server || '';
                document.getElementById('smtp_port').value = cfg.smtp_port || 587;
                document.getElementById('from_email').value = cfg.from_email || '';
                document.getElementById('recipient_email').value = cfg.email || '';
                
                // Afficher le statut
                document.getElementById('status').innerHTML = `
                    <p>‚úÖ Configuration charg√©e</p>
                    <ul>
                        <li>SMTP: ${cfg.smtp_server || 'Non configur√©'}</li>
                        <li>Email: ${cfg.from_email || 'Non configur√©'}</li>
                    </ul>
                `;
            }
        })
        .catch(e => console.error('Erreur:', e));
}

document.getElementById('smtp-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = {
        smtp_server: document.getElementById('smtp_server').value,
        smtp_port: parseInt(document.getElementById('smtp_port').value),
        from_email: document.getElementById('from_email').value,
        password: document.getElementById('password').value,
        email: document.getElementById('recipient_email').value
    };
    
    fetch('/api/config/smtp', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert('Configuration SMTP sauvegard√©e!');
            loadConfig();
        } else {
            alert('Erreur: ' + result.error);
        }
    })
    .catch(e => alert('Erreur: ' + e));
});

function testSMTP() {
    document.getElementById('test-result').style.display = 'block';
    document.getElementById('test-result').innerHTML = 'üîÑ Test en cours...';
    
    fetch('/api/config/smtp/test', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('test-result').innerHTML = '‚úÖ Connexion SMTP r√©ussie!';
                document.getElementById('test-result').style.backgroundColor = '#d4edda';
                document.getElementById('test-result').style.padding = '10px';
                document.getElementById('test-result').style.borderRadius = '5px';
            } else {
                document.getElementById('test-result').innerHTML = '‚ùå Erreur: ' + data.error;
                document.getElementById('test-result').style.backgroundColor = '#f8d7da';
                document.getElementById('test-result').style.padding = '10px';
                document.getElementById('test-result').style.borderRadius = '5px';
            }
        })
        .catch(e => {
            document.getElementById('test-result').innerHTML = '‚ùå Erreur r√©seau: ' + e;
            document.getElementById('test-result').style.backgroundColor = '#f8d7da';
        });
}

// Charger la config au d√©marrage
loadConfig();
</script>
{% endblock %}
